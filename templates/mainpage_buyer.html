{% extends "layout.html" %}

{% block title %}
Buyer Main Page
{% endblock %}

{% block main %}

<div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
<style>
.search-wrapper {
  position: relative;
  width: 100%;
  display: flex;
  align-items: center;
  transition: transform 0.2s ease-in-out;
}

.search-wrapper:focus-within {
  transform: scale(1.02);
}

.search-input {
  width: 100%;
  padding-left: 110px; /* Space for prefix */
  padding-right: 16px;
  border-radius: 9999px;
  background: white;
  border: 2px solid #e5e7eb;
  height: 56px;
  outline: none;
  font-size: 1rem;
  transition: all 0.2s ease;
}

.search-input:focus {
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.search-prefix {
  position: absolute;
  left: 24px;
  top: 50%;
  transform: translateY(-50%);
  color: #6b7280;
  pointer-events: none;
  font-size: 1rem;
  font-weight: 500;
}
</style>

<div class="max-w-7xl mx-auto px-4 py-8">

<!-- Search Bar -->
<form method="GET" action="/search" class="mb-8 max-w-2xl mx-auto">
  <div class="flex gap-3">
    <div class="search-wrapper flex-1">
      <span class="search-prefix">I want to</span>
      <input
        type="text"
        name="query"
        class="search-input"
        placeholder="find a web developer..."
      >
    </div>
    <button type="submit"
      class="px-8 py-3 bg-blue-600 text-white rounded-full font-semibold
             hover:bg-blue-700 transition-all duration-200
             hover:shadow-lg transform hover:scale-105">
      Search
    </button>
  </div>
</form>

{% if items %}
<!-- Category Bar -->
<div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
  <div class="flex flex-wrap gap-3 justify-center items-center">
    <span class="text-gray-700 font-semibold text-lg mr-2">Filter by Interest:</span>
    {% for tag in tags %}
    <button type="button"
      class="category-btn px-5 py-2.5 border-2 border-gray-300 rounded-full text-sm font-semibold text-gray-700 
             hover:bg-blue-50 hover:border-blue-500 transition-all duration-200
             focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2
             transform hover:scale-105"
      onclick="toggleCategory('{{ tag }}')"
      data-tag="{{ tag }}">
      {{ tag }}
    </button>
    {% endfor %}
  </div>
</div>
<!-- Services Grid -->
<div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
{% for item in items %}
<a href="/service/{{ item.id }}" class="group">
  <div class="bg-white rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-2 overflow-hidden h-full flex flex-col">
    <!-- Service Image -->
    <div class="w-full h-48 overflow-hidden bg-gray-100">
      <img src="{{ item.image_url or '/static/default_image.png' }}"
           class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300" 
           alt="{{ item.title }}" />
    </div>
    
    <!-- Service Details -->
    <div class="p-6 flex-1 flex flex-col">
      <div class="flex items-center gap-2 mb-3">
        <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
          <span class="text-blue-600 font-bold text-sm">{{ item.seller_username[0].upper() }}</span>
        </div>
        <span class="text-sm font-medium text-gray-600">{{ item.seller_username }}</span>
      </div>
      
      <h3 class="text-xl font-bold text-gray-900 mb-2 group-hover:text-blue-600 transition-colors duration-200">{{ item.title }}</h3>
      <p class="text-gray-600 mb-4 line-clamp-2 flex-1">{{ item.description }}</p>
      
      <div class="flex items-center justify-between pt-4 border-t border-gray-100">
        <span class="text-2xl font-bold text-blue-600">RM {{ item.price }}</span>
        <span class="text-blue-600 font-semibold group-hover:translate-x-1 transition-transform duration-200 inline-flex items-center">
          View Details
          <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        </span>
      </div>
    </div>
  </div>
</a>
{% endfor %}
</div>

{% else %}
<!-- Empty State -->
<div class="bg-white rounded-2xl shadow-lg p-12 text-center max-w-2xl mx-auto">
  <svg class="w-20 h-20 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
  </svg>
  <h3 class="text-2xl font-bold text-gray-900 mb-2">No services available</h3>
  <p class="text-gray-600 mb-6">You can create your own services or try searching at another time.</p>
  <a href="/seller" class="inline-block bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors duration-200">
    Create a Service
  </a>
</div>
{% endif %}

</div>
</div>

<script>
// Category selection functionality with auto-apply
function toggleCategory(tag) {
  const currentCategory = getSelectedCategory();
  
  // If clicking the same category, deselect it; otherwise select the new one
  const newCategory = (currentCategory === tag) ? null : tag;
  
  // Save and apply immediately
  applyCategory(newCategory);
}

function getSelectedCategory() {
  // Get from server-side rendered data (single category)
  const category = {{ selected_category | tojson | safe }};
  return category;
}

function applyCategory(category) {
  // Create form and submit
  const form = document.createElement('form');
  form.method = 'POST';
  form.action = '/set_preferences';
  
  const input = document.createElement('input');
  input.type = 'hidden';
  input.name = 'selected_tags';
  // Send as array with single item or empty array
  input.value = JSON.stringify(category ? [category] : []);
  
  form.appendChild(input);
  document.body.appendChild(form);
  form.submit();
}

// Initialize button states on page load
document.addEventListener('DOMContentLoaded', () => {
  const selectedCategory = getSelectedCategory();
  
  document.querySelectorAll(".category-btn").forEach(button => {
    const tag = button.dataset.tag;
    
    if (tag === selectedCategory) {
      button.classList.add("bg-blue-600", "text-white", "border-blue-600");
      button.classList.remove("text-gray-700", "border-gray-300");
    }
  });
});
</script>

{% endblock %}
